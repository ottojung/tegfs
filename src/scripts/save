#! /bin/sh

if ! command -v xclip
then echo "This script requires 'xclip' to be installed" 1>&2 ; exit 1
fi

if ! command -v tegfs
then echo "This script requires 'tegfs' to be installed" 1>&2 ; exit 1
fi

if test -z "$TEGFS_ROOT"
then
	echo "Cannot cd into root because \$TEGFS_ROOT env variable is not set" 1>&2
	exit 1
fi

cd "$TEGFS_ROOT"

REG_SUFFIX=".tegfs.org"

REG_FILES=$(find -name "*$REG_SUFFIX")
if test -z "$REG_FILES"
then REG_FILES_LEN=0
else REG_FILES_LEN=$(echo "$REG_FILES" | wc -l)
fi

echo "REG FILES: <$REG_FILES>"
echo "LEN: <$REG_FILES_LEN>"

case "$REG_FILES_LEN" in
	0)
		echo 'No existing registry files found' 1>&2
		echo 'Enter a name for the new one:' 1>&2
		read CHOSEN_REG_FILE
		case "$CHOSEN_REG_FILE" in
			*$REG_SUFFIX) ;;
			*) CHOSEN_REG_FILE="$CHOSEN_REG_FILE$REG_SUFFIX" ;;
		esac

		echo > "$CHOSEN_REG_FILE"
		echo '# This file was automatically generated by the save script' >> "$CHOSEN_REG_FILE"
		echo >> "$CHOSEN_REG_FILE"
		echo >> "$CHOSEN_REG_FILE"
		;;
	1)
		CHOSEN_REG_FILE="$REG_FILES"
		;;
	*)
		CHOSEN_REG_FILE=$(echo "$REG_FILES" | fzf)
		;;
esac

echo CHOSEN: $CHOSEN_REG_FILE
